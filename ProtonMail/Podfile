source 'https://cdn.cocoapods.org/'

def proton_core_path
  'git@gitlab.protontech.ch:apple/shared/protoncore.git'
end

# proton url is set to env variable because the core module podspecs expect it. 
# it's part of transition into open sourced core modules and it will not be necessary when they are on github
ENV['PROTON_CORE_GIT_URL'] = proton_core_path
source proton_core_path

platform :ios, '11.0'
inhibit_all_warnings!
use_frameworks!

def proton_core_version
  '2.4.0'
end

def pm_shared_pods
  pod 'ProtonCore-Networking/Alamofire', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-Crypto', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-SRP', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-Authentication', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-Keymaker', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-Payments', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
end

def common_pods
  pm_shared_pods
  pod 'ProtonCore-UIFoundations', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-Common', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-OpenPGP', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-Authentication-KeyGeneration', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'Groot', '3.0.1'
#  pod 'AFNetworking', '4.0.1'
  pod 'Masonry', '1.1.0'
  pod 'PromiseKit', '6.13.1'
  pod 'AwaitKit', '5.2.0'
  pod 'MCSwipeTableViewCell', '2.1.4'
  pod 'Sentry', :git => 'https://github.com/getsentry/sentry-cocoa.git', :tag => '4.5.0'
  pod 'MBProgressHUD' , '1.1.0'
  pod 'TrustKit', :git=> 'https://github.com/ProtonMail/TrustKit.git', :branch => 'master'
  pod 'SwiftGen', '~> 6.0'
end

def pm_pods
  common_pods
  pod 'SwipyCell', :git=> 'https://github.com/xxi511/SwipyCell.git', :branch =>  'main'
  pod 'DKImagePickerController/PhotoGallery', '~> 4.2.0'
  pod 'ProtonCore-Challenge', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-CoreTranslation', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-Log', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-AccountSwitcher', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-ForceUpgrade', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-HumanVerification', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-Login', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'SideMenuSwift', '2.0.6'
  pod "SkeletonView", '1.11.0'
  pod 'OHHTTPStubs/Swift', '9.0.0', :configurations => ['Debug']
end

def pm_share
  common_pods
end

def pm_siri
  pm_shared_pods
end

target 'ProtonMail' do
  pm_pods
end

target 'PushService' do
  pm_shared_pods
end

target 'ProtonMailDev' do
  pm_pods
end

target 'PushServiceDev' do
  pm_shared_pods
end

target 'ProtonMailTests' do
  inherit! :search_paths
#  pod 'AFNetworking', '4.0.1'
  pod 'OHHTTPStubs/Swift', '9.0.0'
  pod 'Groot', '3.0.1'
  pod 'PromiseKit', '6.13.1'
  pod 'ProtonCore-TestingToolkit/UnitTests/Core', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-TestingToolkit/UnitTests/Doh', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-TestingToolkit/UnitTests/Services', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-TestingToolkit/UnitTests/Login', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pm_pods
end

target 'ProtonMailUITests' do
  inherit! :search_paths
  pod 'pmtest', :git => 'git@gitlab.protontech.ch:apple/shared/pmtestautomation.git', :branch =>'master'
  pod 'ProtonCore-TestingToolkit/UITests/HumanVerification', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
  pod 'ProtonCore-TestingToolkit/UITests/Login', :git=> 'git@gitlab.protontech.ch:apple/shared/protoncore.git', :commit => '07fc0e4fa250872c8df130f3e'
end

target 'Share' do
  pm_share
end

target 'ShareDev' do
  pm_share
end

target 'Siri' do
  pm_siri
end

target 'SiriDev' do
  pm_siri
end

post_install do | installer |
  require 'fileutils'
  FileUtils.cp_r('Pods/Target Support Files/Pods-ProtonMail/Pods-ProtonMail-Acknowledgements.plist', 'ProtonMail/Supporting Files/Settings.bundle/Acknowledgements.plist', :remove_destination => true)
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '11.0'
      config.build_settings['SWIFT_VERSION'] = '5.0'
      config.build_settings['ENABLE_BITCODE'] = 'NO'
      if config.name == 'Release'
        config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-Owholemodule'
        else
        config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-Onone'
      end
    end
  end
end
