source 'https://cdn.cocoapods.org/'
platform :ios, '11.0'

inhibit_all_warnings!
use_frameworks!

def proton_core_path
  'git@gitlab.protontech.ch:apple/shared/protoncore.git'
end

def proton_core_branch
  'main'
end

def pm_shared_pods
  pod 'ProtonCore-Crypto', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-SRP', :git => proton_core_path, :branch => proton_core_branch

  # dependencies of Authentication
  pod "ProtonCore-Services", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Log", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-DataModel", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Utilities", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Doh", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Networking", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-APIClient", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-OpenPGP", :git => proton_core_path, :branch => proton_core_branch

  pod 'ProtonCore-Authentication', :git => proton_core_path, :branch => proton_core_branch

  # dependencies of Keymaker
  pod 'ProtonCore-Crypto', :git => proton_core_path, :branch => proton_core_branch

  pod 'ProtonCore-Keymaker', :git => proton_core_path, :branch => proton_core_branch

  # dependencies of Payments
  pod 'ProtonCore-APIClient', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-Networking', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-Doh', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-Log', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-Services', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-DataModel', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-Utilities', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-Authentication', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-Crypto', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-OpenPGP', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-SRP', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-CoreTranslation', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-Foundations', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-UIFoundations', :git => proton_core_path, :branch => proton_core_branch

  pod 'ProtonCore-Payments', :git => proton_core_path, :branch => proton_core_branch

end

def common_pods
  pm_shared_pods

  # dependencies of UIFoundations
  pod 'ProtonCore-Log', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-Foundations', :git => proton_core_path, :branch => proton_core_branch

  pod 'ProtonCore-UIFoundations', :git => proton_core_path, :branch => proton_core_branch

  # dependencies of Common
  pod "ProtonCore-Services", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Log", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-DataModel", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Utilities", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Doh", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Networking", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-APIClient", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-UIFoundations", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Foundations", :git => proton_core_path, :branch => proton_core_branch

  pod 'ProtonCore-Common', :git => proton_core_path, :branch => proton_core_branch

  pod 'ProtonCore-OpenPGP', :git => proton_core_path, :branch => proton_core_branch

  pod 'Groot', '3.0.1'
  pod 'AFNetworking', '4.0.1'
  pod 'NSDate+Helper', :git => 'https://github.com/ProtonMail/nsdate-helper.git', :branch => 'master'
  pod 'Masonry', '1.1.0'
  pod 'UIColor+Hex', '1.0.1'
  pod 'PromiseKit', '6.13.1'
  pod 'AwaitKit', '5.0.1'
  pod 'MCSwipeTableViewCell', '2.1.4'
  pod 'Sentry', :git => 'https://github.com/getsentry/sentry-cocoa.git', :tag => '4.5.0'
  pod 'MBProgressHUD' , '1.1.0'
  pod 'TrustKit', :git=> 'https://github.com/ProtonMail/TrustKit.git', :branch => 'master'
  pod 'SwiftGen', '~> 6.0'
end

def pm_pods

  common_pods

  pod 'SwipyCell', '4.0.1'
  pod 'DKImagePickerController/PhotoGallery', '~> 4.2.0'

  # dependencies of Challenge
  pod 'ProtonCore-Foundations', :git => proton_core_path, :branch => proton_core_branch

  pod 'ProtonCore-Challenge', :git => proton_core_path, :branch => proton_core_branch

  pod 'ProtonCore-CoreTranslation', :git => proton_core_path, :branch => proton_core_branch

  pod 'ProtonCore-Log', :git => proton_core_path, :branch => proton_core_branch

  # dependencies of AccountSwitcher
  pod 'ProtonCore-Log', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-CoreTranslation', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-UIFoundations', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-Foundations', :git => proton_core_path, :branch => proton_core_branch

  pod 'ProtonCore-AccountSwitcher', :git => proton_core_path, :branch => proton_core_branch
  
  pod 'ProtonCore-ForceUpgrade', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-HumanVerification', :git => proton_core_path, :branch => proton_core_branch

  # dependencies of Login
  pod "ProtonCore-Log", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Crypto", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-OpenPGP", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Authentication", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Services", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-DataModel", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Utilities", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Doh", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Networking", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-APIClient", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Foundations", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-UIFoundations", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-CoreTranslation", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-Challenge", :git => proton_core_path, :branch => proton_core_branch
  pod "ProtonCore-HumanVerification", :git => proton_core_path, :branch => proton_core_branch

  pod 'ProtonCore-Login', :git => proton_core_path, :branch => proton_core_branch

  pod 'SideMenuSwift', '2.0.6'
  pod "SkeletonView", '1.11.0'
  pod 'OHHTTPStubs/Swift', '9.0.0', :configurations => ['Debug']
end

def pm_share
  common_pods
end

def pm_siri
  pm_shared_pods
end

target 'ProtonMail' do
  pm_pods
end

target 'PushService' do
  pm_shared_pods
end

target 'ProtonMailDev' do
  pm_pods
end

target 'PushServiceDev' do
  pm_shared_pods
end

target 'ProtonMailTests' do
  inherit! :search_paths
  pod 'AFNetworking', '4.0.1'
  pod 'OHHTTPStubs/Swift', '9.0.0'
  pod 'Groot', '3.0.1'
  pod 'PromiseKit', '6.13.1'

  pod 'ProtonCore-TestingToolkit/UnitTests/Core', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-TestingToolkit/UnitTests/Doh', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-TestingToolkit/UnitTests/Services', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-TestingToolkit/UnitTests/Login', :git => proton_core_path, :branch => proton_core_branch 

  pm_pods
end

target 'ProtonMailUITests' do
  inherit! :search_paths

  pod 'PMTestAutomation', :git => 'git@gitlab.protontech.ch:apple/shared/pmtestautomation.git', :branch => 'master'
  
  pod 'ProtonCore-TestingToolkit/UITests/HumanVerification', :git => proton_core_path, :branch => proton_core_branch
  pod 'ProtonCore-TestingToolkit/UITests/Login', :git => proton_core_path, :branch => proton_core_branch   
end

target 'Share' do
  pm_share
end
target 'ShareDev' do
  pm_share
end

target 'Siri' do
  pm_siri
end
target 'SiriDev' do
  pm_siri
end

post_install do | installer |
  require 'fileutils'
  FileUtils.cp_r('Pods/Target Support Files/Pods-ProtonMail/Pods-ProtonMail-Acknowledgements.plist', 'ProtonMail/Supporting Files/Settings.bundle/Acknowledgements.plist', :remove_destination => true)

  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '11.0'
      config.build_settings['SWIFT_VERSION'] = '5.0'
      config.build_settings['ENABLE_BITCODE'] = 'NO'
      if config.name == 'Release'
        config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-Owholemodule'
        else
        config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-Onone'
      end
    end
  end
end

