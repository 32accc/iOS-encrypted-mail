source 'https://cdn.cocoapods.org/'

def proton_core_path
  "git@gitlab.protontech.ch:apple/shared/protoncore.git"
end

# proton url is set to env variable because the core module podspecs expect it.
# it's part of transition into open sourced core modules and it will not be necessary when they are on github
ENV['PROTON_CORE_GIT_URL'] = proton_core_path
source proton_core_path

platform :ios, '11.0'
inhibit_all_warnings!
use_frameworks!

def proton_core_version
  '3.22.3'
end

def common_pods
  pod 'Alamofire', '5.4.4'
  pod 'AwaitKit', :git => 'https://github.com/yannickl/AwaitKit.git', :commit => '4b725f40dd189f40c0962cba792f06a2073bd977'
  pod 'Groot', '3.0.1'
  pod 'Masonry', '1.1.0'
  pod 'MBProgressHUD' , '1.1.0'
  pod 'MCSwipeTableViewCell', '2.1.4'
  pod 'PromiseKit', '6.13.1'
  pod 'ProtonCore-Authentication-KeyGeneration/UsingCrypto+Alamofire', proton_core_version
  pod 'ProtonCore-Authentication/UsingCrypto+Alamofire', proton_core_version
  pod 'ProtonCore-Common-V5/Alamofire', proton_core_version
  pod 'ProtonCore-Crypto', proton_core_version
  pod 'ProtonCore-Hash', proton_core_version
  pod 'ProtonCore-Keymaker/UsingCrypto', proton_core_version
  pod 'ProtonCore-Networking/Alamofire', proton_core_version
  pod 'ProtonCore-Services/Alamofire', proton_core_version
  pod 'ProtonCore-UIFoundations-V5', proton_core_version
  pod 'SwiftSoup', '~> 2.3'
  pod 'TrustKit', :git=> 'https://github.com/ProtonMail/TrustKit.git', :branch => 'master'
  pod 'SQLite.swift', '~> 0.13.3'
end

def pm_pods
  common_pods
  pod 'DKImagePickerController/PhotoGallery', '~> 4.2.0'
  pod 'LifetimeTracker'
  pod 'OHHTTPStubs/Swift', '9.0.0', :configurations => ['Production Debug', 'Enterprise Debug']
  pod 'ProtonCore-AccountDeletion-V5/UsingCrypto+Alamofire', proton_core_version
  pod 'ProtonCore-AccountSwitcher-V5', proton_core_version
  pod 'ProtonCore-Challenge', proton_core_version
  pod 'ProtonCore-CoreTranslation-V5', proton_core_version
  pod 'ProtonCore-CoreTranslation', proton_core_version
  pod 'ProtonCore-ForceUpgrade-V5/Alamofire', proton_core_version
  pod 'ProtonCore-HumanVerification-V5/Alamofire', proton_core_version
  pod 'ProtonCore-Log', proton_core_version
  pod 'ProtonCore-Login/UsingCrypto+Alamofire', proton_core_version
  pod 'ProtonCore-LoginUI-V5/UsingCrypto+Alamofire', proton_core_version
  pod 'ProtonCore-OpenPGP', proton_core_version
  pod 'ProtonCore-Payments/UsingCrypto+Alamofire', proton_core_version
  pod 'ProtonCore-PaymentsUI-V5/UsingCrypto+Alamofire', proton_core_version
  pod 'SideMenuSwift', '2.0.6'
  pod 'SwipyCell', :git=> 'https://github.com/xxi511/SwipyCell.git', :branch =>  'main'
  pod "SkeletonView", '1.11.0'
end

def pm_share
  common_pods
end

def pm_siri
  pod 'ProtonCore-Crypto', proton_core_version
  pod 'ProtonCore-Keymaker/UsingCrypto', proton_core_version
end

def pm_pushService
  pod 'ProtonCore-Crypto', proton_core_version
  pod 'ProtonCore-Doh', proton_core_version
  pod 'ProtonCore-Keymaker/UsingCrypto', proton_core_version
  pod 'ProtonCore-DataModel', proton_core_version
end

target 'ProtonMail' do
  pm_pods
end

target 'PushService' do
  pm_pushService
end

target 'ProtonMailTests' do
  inherit! :search_paths
  pod 'OHHTTPStubs/Swift', '9.0.0'
  pod 'Groot', '3.0.1'
  pod 'PromiseKit', '6.13.1'
  pod 'ProtonCore-TestingToolkit/UnitTests/Core', proton_core_version
  pod 'ProtonCore-TestingToolkit/UnitTests/Doh', proton_core_version
  pod 'ProtonCore-TestingToolkit/UnitTests/Services/Alamofire', proton_core_version
  pod 'ProtonCore-TestingToolkit/UnitTests/Login/UsingCrypto+Alamofire', proton_core_version
  pod 'ProtonCore-TestingToolkit/UnitTests/LoginUI-V5/UsingCrypto+Alamofire', proton_core_version
  pod 'ProtonCore-TestingToolkit/UnitTests/DataModel',  proton_core_version
  pod 'ProtonCore-TestingToolkit/UnitTests/Networking/Alamofire', proton_core_version
  pod 'ProtonCore-TestingToolkit/UnitTests/HumanVerification-V5/Alamofire', proton_core_version
  pod 'ProtonCore-TestingToolkit/UnitTests/Authentication/UsingCrypto+Alamofire', proton_core_version
  pm_pods
end

target 'ProtonMailUITests' do
  inherit! :search_paths
  pod 'pmtest', :git => 'git@gitlab.protontech.ch:apple/shared/pmtestautomation.git', :branch => 'master'
  pod 'ProtonCore-TestingToolkit/UITests/HumanVerification', proton_core_version
  pod 'ProtonCore-TestingToolkit/UITests/Login', proton_core_version
  pod 'ProtonCore-TestingToolkit/UITests/AccountDeletion', proton_core_version
  pod 'ProtonCore-QuarkCommands/Alamofire', proton_core_version
end

target 'Share' do
  pm_share
end

target 'Siri' do
  pm_siri
end

target 'ProtonMailAnalytics' do
  pod 'Sentry', :git => 'https://github.com/getsentry/sentry-cocoa.git', :tag => '7.8.0'
end

post_install do | installer |
  require 'fileutils'
  FileUtils.cp_r('Pods/Target Support Files/Pods-ProtonMail/Pods-ProtonMail-Acknowledgements.plist', 'ProtonMail/Supporting Files/Settings.bundle/Acknowledgements.plist', :remove_destination => true)
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '11.0'
      config.build_settings['SWIFT_VERSION'] = '5.0'
      config.build_settings['ENABLE_BITCODE'] = 'NO'
      if config.name.include? 'Release'
        config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-Owholemodule'
        else
        config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-Onone'
      end
    end
  end
end
